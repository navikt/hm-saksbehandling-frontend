name: Bygg, deploy til dev-gcp og lag release
on:
  push:
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENCE'
      - 'CODEOWNERS'
    branches:
      - main

env:
  IMAGE: ghcr.io/${{ github.repository }}:${{ github.sha }}

jobs:
  test:
    name: Kj√∏r Cypress-tester
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Cypress run
        uses: cypress-io/github-action@v6
        with:
          start: npm run dev
          wait-on: 'http://ip6-localhost:3001'
          working-directory: client
          config-file: cypress.config.ts
          record: false

  build:
    name: Bygg
    permissions:
        packages: write
        contents: write
        id-token: write
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: navikt/digihot-deploy/actions/pre-deploy@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DOCKER_IMAGE: ghcr.io/navikt/hotsak-frontend
      - uses: docker/setup-buildx-action@v2
      - name: Push docker image to GAR
        uses: nais/docker-build-push@v0
        id: docker-build-push
        with:
           team: teamdigihot
           identity_provider: ${{ secrets.NAIS_WORKLOAD_IDENTITY_PROVIDER }} 
           project_id: ${{ vars.NAIS_MANAGEMENT_PROJECT_ID }} 
        
      
      #- uses: docker/login-action@v2
      #  with:
      #    registry: ghcr.io
      #    username: ${{ github.actor }}
      #    password: ${{ secrets.GITHUB_TOKEN }}
      #- uses: docker/build-push-action@v3
      #  with:
      #    push: true
      #    tags: ${{ env.IMAGE }}
      #    cache-from: type=gha
      #    cache-to: type=gha,mode=max
      #    context: .


  deploy-labs:
     name: Deploy til labs-gcp
     runs-on: ubuntu-latest
     needs: [build]
     permissions:
        contents: write
        id-token: write
     timeout-minutes: 15
     steps:
        - uses: actions/checkout@v4
        - uses: nais/deploy/actions/deploy@v2
          env:
             CLUSTER: dev-gcp
             RESOURCE: .nais/labs.yaml
             IMAGE: ${{ needs.build.outputs.image }}

  deploy-dev:
     name: Deploy til dev-gcp
     runs-on: ubuntu-latest
     needs: [build]
     permissions:
        contents: write
        id-token: write
     timeout-minutes: 15
     steps:
        - uses: actions/checkout@v4
        - uses: nais/deploy/actions/deploy@v2
          env:
             CLUSTER: dev-gcp
             RESOURCE: .nais/dev.yaml
             IMAGE: ${{ needs.build.outputs.image }}
        - uses: navikt/digihot-deploy/actions/post-deploy@v2
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        - uses: actions/create-release@latest
          if: github.ref == 'refs/heads/main'
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            tag_name: ${{ env.VERSION_TAG }}
            release_name: ${{ env.APPLICATION }} ${{ env.VERSION_TAG }}
            body: ${{ env.CHANGE_LOG }}
            draft: true
            prerelease: false



   
